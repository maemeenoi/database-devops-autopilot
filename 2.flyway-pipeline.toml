# =============================================================================
# Flyway Configuration for CI/CD PIPELINE (GitHub Actions)
# =============================================================================
# This file uses environment variable resolution with ${env.VARIABLE_NAME} syntax
# Environment variables are securely provided through GitHub Secrets
# This file is safe to commit as it contains no sensitive information
# =============================================================================

id = "database-devops-autopilot-pipeline"
name = "Database DevOps AutoPilot (CI/CD Pipeline)"
databaseType = "SqlServer"

[environments.Build]
# Build environment for clean validation in CI/CD pipeline
url = "jdbc:sqlserver://sqlbits.database.windows.net:1433;databaseName=db-autopilot-build-001;encrypt=true;trustServerCertificate=false"
user = "${env.TARGET_DATABASE_USERNAME}"
password = "${env.TARGET_DATABASE_PASSWORD}"
displayName = "Build Database (CI/CD Validation)"

[environments.Test]
# Test environment for UAT testing in CI/CD pipeline  
url = "jdbc:sqlserver://sqlbits.database.windows.net:1433;databaseName=db-autopilot-uat-002;encrypt=true;trustServerCertificate=false"
user = "${env.TARGET_DATABASE_USERNAME}"
password = "${env.TARGET_DATABASE_PASSWORD}"
displayName = "Test Database (UAT)"

[environments.Prod]
# Production environment - requires manual approval in CI/CD pipeline
url = "jdbc:sqlserver://sqlbits.database.windows.net:1433;databaseName=db-autopilot-prod-003;encrypt=true;trustServerCertificate=false"
user = "${env.TARGET_DATABASE_USERNAME}"
password = "${env.TARGET_DATABASE_PASSWORD}"
displayName = "Production Database"

[flyway]
locations = [ "filesystem:migrations" ]
mixed = true
outOfOrder = true
validateMigrationNaming = true
defaultSchema = "Customers"
baselineOnMigrate = true
baselineVersion = "001"
errorOverrides = [ "S0001:0:I-" ]

[flyway.sqlserver.clean]
mode = "all"

[flyway.sqlserver.clean.schemas]
exclude = [ "ExampleSchema1", "ExampleSchema2" ]

# =============================================================================
# REQUIRED GITHUB SECRETS (configured in repository settings):
# =============================================================================
# TARGET_DATABASE_USERNAME      → Your Azure SQL username (same for all environments)
# TARGET_DATABASE_PASSWORD      → Your Azure SQL password (same for all environments)  
# FLYWAY_EMAIL                  → Your Redgate account email
# FLYWAY_TOKEN                  → Your Personal Access Token
# FLYWAY_CLI_INSTALL            → true (enables CLI auto-install)
# =============================================================================
#
# DATABASE NAMES (hardcoded in TOML - no secrets needed):
# =============================================================================
# Build: db-autopilot-build-xxx    → Clean validation database
# Test:  db-autopilot-uat-xxx      → UAT testing database  
# Prod:  db-autopilot-prod-xxx     → Production database
# =============================================================================
#
# CI/CD PIPELINE FLOW:
# =============================================================================
# 1. Build: Clean + migrate + undo validation (replaces shadow database)
# 2. Test: Deploy to UAT for acceptance testing  
# 3. Prod: Manual approval + production deployment
# =============================================================================